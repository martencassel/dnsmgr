#!/usr/bin/env bash

STATE_FILE="$HOME/.dnsmgr_state"
HOSTS_FILE="/etc/hosts"
BEGIN_MARKER="# BEGIN DNSMGR"
END_MARKER="# END DNSMGR"

# Colors for CLI output
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
RED="\033[0;31m"
RESET="\033[0m"

# Ensure state file exists
touch "$STATE_FILE"

print_help() {
  echo -e "${YELLOW}dnsmgr - Lightweight Domain Manager${RESET}"
  echo
  echo -e "${GREEN}Overview:${RESET}"
  echo "  Manage test domains safely by tracking allocations in ~/.dnsmgr_state"
  echo "  and maintaining a dedicated block in /etc/hosts."
  echo
  echo -e "${GREEN}Usage:${RESET}"
  echo "  dnsmgr <command> [options]"
  echo
  echo -e "${GREEN}Commands:${RESET}"
  printf "  %-20s %s\n" "alloc --pool <range> --ip <ip>" "Allocate next free domain from pool"
  printf "  %-20s %s\n" "add <domain> --ip <ip>"          "Add a specific domain → IP mapping"
  printf "  %-20s %s\n" "release <domain>"               "Release a domain allocation"
  printf "  %-20s %s\n" "list"                           "List all managed domains"
  printf "  %-20s %s\n" "render-env --prefix <PREFIX>"   "Export domains as environment variables"
  printf "  %-20s %s\n" "sync"                           "Reconcile /etc/hosts with state file"
  printf "  %-20s %s\n" "-h, --help"                     "Show this help screen"
  echo
  echo -e "${GREEN}Examples:${RESET}"
  echo "  dnsmgr alloc --pool app1.local-app5.local --ip 127.0.0.1"
  echo "  dnsmgr add mydb.local --ip 10.0.0.5"
  echo "  dnsmgr release mydb.local"
  echo "  dnsmgr list"
  echo "  eval \$(dnsmgr render-env --prefix MYAPP)"
  echo "  dnsmgr sync"
  echo
  echo -e "${GREEN}Notes:${RESET}"
  echo "  - State file: $STATE_FILE"
  echo "  - Hosts file: $HOSTS_FILE"
  echo "  - Managed block is fenced by '$BEGIN_MARKER' and '$END_MARKER'"
}


update_hosts() {
  # Remove old block
  sudo sed -i "/$BEGIN_MARKER/,/$END_MARKER/d" "$HOSTS_FILE"
  # Write new block
  {
    echo "$BEGIN_MARKER"
    while read -r domain ip; do
      [[ -n "$domain" ]] && echo "$ip $domain"
    done < "$STATE_FILE"
    echo "$END_MARKER"
  } | sudo tee -a "$HOSTS_FILE" > /dev/null
}

alloc_domain() {
  local pool="$1"
  local ip="$2"
  local start=$(echo "$pool" | cut -d'-' -f1)
  local end=$(echo "$pool" | cut -d'-' -f2)
  local prefix=$(echo "$start" | sed 's/[0-9]\+.*//')
  local start_num=$(echo "$start" | grep -o '[0-9]\+')
  local end_num=$(echo "$end" | grep -o '[0-9]\+')

  for i in $(seq "$start_num" "$end_num"); do
    domain="${prefix}${i}.local"
    if ! grep -q "^$domain " "$STATE_FILE"; then
      echo "$domain $ip" >> "$STATE_FILE"
      update_hosts
      echo -e "${GREEN}✓ Allocated $domain → $ip${RESET}"
      return
    fi
  done
  echo -e "${RED}No free domains available in pool${RESET}"
}

add_domain() {
  local domain="$1"
  local ip="$2"
  if grep -q "^$domain " "$STATE_FILE"; then
    echo -e "${RED}Domain already allocated${RESET}"
    return
  fi
  echo "$domain $ip" >> "$STATE_FILE"
  update_hosts
  echo -e "${GREEN}✓ Allocated $domain → $ip${RESET}"
}

release_domain() {
  local domain="$1"
  if grep -q "^$domain " "$STATE_FILE"; then
    sed -i "/^$domain /d" "$STATE_FILE"
    update_hosts
    echo -e "${GREEN}✓ Released $domain${RESET}"
  else
    echo -e "${RED}Domain not found${RESET}"
  fi
}

list_domains() {
  echo -e "${YELLOW}Managed Domains${RESET}"
  echo "────────────────────────────"
  count=0
  while read -r domain ip; do
    [[ -n "$domain" ]] && { echo "  $domain → $ip"; ((count++)); }
  done < "$STATE_FILE"
  echo "  ($count domain(s) allocated)"
}

render_env() {
  local prefix="$1"
  count=1
  while read -r domain ip; do
    [[ -n "$domain" ]] && echo "${prefix}_DOMAIN${count}=$domain"
    ((count++))
  done < "$STATE_FILE"
}

sync_hosts() {
  echo -e "${YELLOW}Syncing /etc/hosts with state file...${RESET}"

  # Extract current managed block (without markers)
  current=$(sed -n "/$BEGIN_MARKER/,/$END_MARKER/p" "$HOSTS_FILE" | grep -v "$BEGIN_MARKER" | grep -v "$END_MARKER")

  # Normalize whitespace and empty lines
  current=$(echo "$current" | sed '/^$/d' | sort)
  state=$(sed '/^$/d' "$STATE_FILE" | sort)

  if diff <(echo "$current") <(echo "$state") >/dev/null; then
    echo -e "${GREEN}✓ Already in sync${RESET}"
  else
    echo -e "${RED}Differences found, reconciling...${RESET}"
    update_hosts
    echo -e "${GREEN}✓ Hosts file synchronized with state file${RESET}"
  fi
}

# Command dispatcher
cmd="$1"
shift || true

case "$cmd" in
  alloc)
    while [[ $# -gt 0 ]]; do
      case "$1" in
        --pool) pool="$2"; shift 2 ;;
        --ip) ip="$2"; shift 2 ;;
        *) shift ;;
      esac
    done
    alloc_domain "$pool" "$ip"
    ;;
  add)
    domain="$1"; shift
    while [[ $# -gt 0 ]]; do
      case "$1" in
        --ip) ip="$2"; shift 2 ;;
        *) shift ;;
      esac
    done
    add_domain "$domain" "$ip"
    ;;
  release)
    release_domain "$1"
    ;;
  list)
    list_domains
    ;;
  render-env)
    while [[ $# -gt 0 ]]; do
      case "$1" in
        --prefix) prefix="$2"; shift 2 ;;
        *) shift ;;
      esac
    done
    render_env "$prefix"
    ;;
  sync)
    sync_hosts
    ;;
  ""|-h|--help)
    print_help
    ;;
  *)
    echo -e "${RED}Unknown command${RESET}"
    print_help
    ;;
esac
